<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gest√£o de Buffet Al√©m do Bolo</title>
  <style>
    :root { --primaria:#0f172a; --destaque:#10b981; --fundo:#f8fafc; --borda:#e2e8f0; }
    body { font-family: 'Segoe UI', sans-serif; margin:0; display:flex; background:var(--fundo); color:#334155; }
    nav { width:320px; background:var(--primaria); height:100vh; position:fixed; padding:25px; color:white; box-shadow:4px 0 10px rgba(0,0,0,.12); }
    nav h2 { font-size:1.1rem; color:var(--destaque); margin-bottom:18px; border-bottom:1px solid #1e293b; padding-bottom:12px; }
    .label-grupo { font-size:0.7rem; color:#64748b; text-transform:uppercase; letter-spacing:1px; margin:16px 0 8px; }
    .btn-menu { width:100%; padding:10px; margin-bottom:8px; background:#1e293b; border:none; color:white; text-align:left; border-radius:6px; cursor:pointer; transition:.2s; }
    .btn-menu:hover { background:var(--destaque); color:#0f172a; font-weight:bold; }
    main { margin-left:360px; padding:28px; width:100%; }
    .card { background:white; padding:22px; border-radius:10px; border:1px solid var(--borda); box-shadow:0 4px 6px -1px rgba(0,0,0,.06); }
    .caminho { margin-bottom:16px; font-size:.9rem; color:#64748b; cursor:pointer; }
    .caminho span:hover { color:var(--destaque); text-decoration:underline; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th { text-align:left; padding:12px; background:#f1f5f9; color:#475569; font-size:.85rem; }
    td { padding:12px; border-bottom:1px solid var(--borda); }
    .linha-clicavel { cursor:pointer; transition:.2s; }
    .linha-clicavel:hover { background:#f8fafc; }
    .btn-qtd { padding:6px 10px; border:1px solid var(--borda); background:white; cursor:pointer; border-radius:4px; }
    .alerta { color:#ef4444; font-weight:bold; }
    /* Proposta / UI extra */
    .packages { display:flex; gap:12px; margin-top:14px; }
    .pkg { padding:12px; border-radius:8px; background:#f8fafc; border:1px solid var(--borda); cursor:pointer; flex:1; text-align:center; }
    .pkg.active { background:var(--destaque); color:white; font-weight:700; }
    .items-list { margin-top:14px; }
    .item-row { display:flex; gap:12px; align-items:center; padding:8px; border-bottom:1px dashed var(--borda); }
    .item-row input[type="number"] { width:60px; padding:6px; border:1px solid var(--borda); border-radius:6px; }
    .actions { margin-top:14px; display:flex; gap:8px; }
    .btn { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; }
    .btn.primary { background:var(--destaque); color:white; }
    .btn.ghost { background:white; border:1px solid var(--borda); }
    /* Proposta visual */
    #proposal-preview { margin-top:18px; }
    .proposal-card { width:700px; padding:22px; border-radius:10px; background:linear-gradient(180deg,#ffffff, #f9fafb); color:#0f172a; box-shadow:0 10px 30px rgba(2,6,23,.12); }
    .proposal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .proposal-items { margin-top:8px; }
    .staff-panel { margin-top:18px; padding:12px; background:#fff7ed; border-radius:8px; border:1px solid #fde3c6; }
    .note { font-size:.9rem; color:#7b341e; }
  </style>
</head>
<body>

<nav>
  <h2>BUFFET ALEM DO BOLO</h2>

  <div class="label-grupo">Armazenamento</div>
  <button class="btn-menu" onclick="trocarCategoria('C√¢mara')">üì¶ Itens de C√¢mara</button>
  <button class="btn-menu" onclick="trocarCategoria('Freezer')">‚ùÑÔ∏è Itens de Freezer</button>

  <div class="label-grupo">Operacional</div>
  <button class="btn-menu" onclick="trocarCategoria('Equipamento')">‚ö° Equipamentos</button>
  <button class="btn-menu" onclick="trocarCategoria('Material')">üçΩÔ∏è Materiais / Lou√ßas</button>

  <div class="label-grupo">Comercial - Propostas</div>
  <button class="btn-menu" onclick="openProposal('Caf√© Manh√£')">‚òï Caf√© Manh√£</button>
  <button class="btn-menu" onclick="openProposal('Coffee Meal')">ü•™ Coffee Meal</button>
  <button class="btn-menu" onclick="openProposal('Almo√ßo')">üçõ Almo√ßo</button>
  <button class="btn-menu" onclick="openProposal('Janta')">üçΩÔ∏è Janta</button>
  <button class="btn-menu" onclick="openProposal('Coquetelaria')">üç∏ Coquetelaria</button>

  <div class="label-grupo" style="margin-top:22px">Admin</div>
  <button class="btn-menu" onclick="openStaffPanel()">üõü Painel do Staff</button>
</nav>

<main>
  <div id="navegacao" class="caminho"></div>

  <div class="card">
    <h1 id="titulo-pagina">Selecione uma op√ß√£o ao lado</h1>
    <div id="corpo-pagina">Escolha uma categoria para gerenciar o estoque ou criar uma proposta.</div>
  </div>

  <div id="proposal-preview"></div>
  <div id="staff-area"></div>
</main>

<!-- html2canvas para exportar a proposta como imagem -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
/* Banco de Dados Local - carregado desde localStorage se existir */
let estoque = JSON.parse(localStorage.getItem('buffet_rio_db')) || [
  { id:1, cat:"C√¢mara", local:"C√¢mara Fria 1", setor:"Estante A", nome:"Carne Bovina", qtd:25, min:10, info:"-2¬∞C", tipo:"ingrediente" },
  { id:2, cat:"C√¢mara", local:"C√¢mara Fria 1", setor:"Estante B", nome:"Latic√≠nios", qtd:8, min:15, info:"Validade curta", tipo:"ingrediente" },
  { id:3, cat:"Freezer", local:"Freezer Vertical", setor:"Gaveta 1", nome:"Polpas de Fruta", qtd:40, min:10, info:"", tipo:"ingrediente" },
  { id:4, cat:"Equipamento", local:"Cozinha Central", setor:"Bancada", nome:"Fritadeira El√©trica", qtd:2, min:1, info:"Voltagem:220V", tipo:"equipamento" },
  { id:5, cat:"Material", local:"Dep√≥sito", setor:"Prateleira 4", nome:"Pratos Rasos", qtd:150, min:100, info:"Porcelana Branca", tipo:"material" }
];
localStorage.setItem('buffet_rio_db', JSON.stringify(estoque));

/* Estado */
let catAtual = "";
let setorAtual = "";
let currentProposal = null;

/* Mapa de propostas: cada pacote referencia produtos por id e quantidade sugerida */
const propostas = {
  "Caf√© Manh√£": {
    Simples: [{id:5, qty:30}, {id:3, qty:10}], // ex: pratos e polpas
    Medio:   [{id:5, qty:50}, {id:3, qty:20}, {id:2, qty:10}],
    Premium: [{id:5, qty:80}, {id:3, qty:30}, {id:2, qty:20}, {id:1, qty:10}]
  },
  "Coffee Meal": {
    Simples: [{id:5, qty:20}, {id:3, qty:15}],
    Medio:   [{id:5, qty:40}, {id:3, qty:30}, {id:2, qty:10}],
    Premium: [{id:5, qty:60}, {id:3, qty:40}, {id:2, qty:20}, {id:1, qty:15}]
  },
  "Almo√ßo": {
    Simples:[{id:1,qty:10},{id:5,qty:40}],
    Medio:[{id:1,qty:20},{id:5,qty:60},{id:3,qty:20}],
    Premium:[{id:1,qty:35},{id:5,qty:80},{id:3,qty:30}]
  },
  "Janta": {
    Simples:[{id:1,qty:12},{id:5,qty:40}],
    Medio:[{id:1,qty:25},{id:5,qty:70},{id:3,qty:25}],
    Premium:[{id:1,qty:40},{id:5,qty:100},{id:3,qty:40}]
  },
  "Coquetelaria": {
    Simples:[{id:5,qty:20},{id:3,qty:10}],
    Medio:[{id:5,qty:40},{id:3,qty:20}],
    Premium:[{id:5,qty:60},{id:3,qty:40},{id:4,qty:1}] // inclui equipamento exemplo
  }
};

/* Estado de equipamentos em eventos (simula ponto de verifica√ß√£o de disponibilidade)
   cada entrada: equipamentoId -> {status: 'dispon√≠vel'|'em evento', onde: 'Evento X' } */
let equipamentosStatus = JSON.parse(localStorage.getItem('equip_status')) || {
  4: { status: "em evento", onde: "Casamento - Praia" } // fritadeira ocupada
};
localStorage.setItem('equip_status', JSON.stringify(equipamentosStatus));

/* Navega√ß√£o / render */
function trocarCategoria(cat) {
  catAtual = cat; setorAtual = ""; renderizar();
}
function renderizar() {
  const titulo = document.getElementById('titulo-pagina');
  const corpo = document.getElementById('corpo-pagina');
  const navBar = document.getElementById('navegacao');

  if (!catAtual) {
    navBar.innerHTML = "";
    titulo.innerText = "Selecione uma op√ß√£o ao lado";
    corpo.innerHTML = "Escolha uma categoria para gerenciar o estoque ou criar uma proposta.";
    return;
  }

  navBar.innerHTML = `<span onclick="catAtual='';renderizar()">In√≠cio</span> > <b>${catAtual}</b>`;
  titulo.innerText = `Setores da ${catAtual}`;

  const setores = [...new Set(estoque.filter(i => i.cat===catAtual).map(i=>i.setor))];
  let html = `<table><thead><tr><th>Setor / Localiza√ß√£o</th><th>Qtd Total</th></tr></thead><tbody>`;
  setores.forEach(s=>{
    const total = estoque.filter(i=>i.cat===catAtual && i.setor===s).reduce((a,b)=>a+b.qtd,0);
    html += `<tr class="linha-clicavel" onclick="abrirSetor('${s}')">
              <td>üìÇ Setor: <b>${s}</b></td>
              <td>${total}</td>
            </tr>`;
  });
  corpo.innerHTML = html + "</tbody></table>";
}

function abrirSetor(s) {
  setorAtual = s; renderizarSetor();
}

function renderizarSetor() {
  const navBar = document.getElementById('navegacao');
  navBar.innerHTML = `<span onclick="setorAtual='';renderizar()">In√≠cio > ${catAtual}</span> > <b>${setorAtual}</b>`;
  document.getElementById('titulo-pagina').innerText = `Itens em: ${setorAtual}`;
  const itens = estoque.filter(i=>i.cat===catAtual && i.setor===setorAtual);
  let html = `<table><thead><tr><th>Item</th><th>Qtd</th><th>Info T√©cnica</th><th>Movimenta√ß√£o</th></tr></thead><tbody>`;
  itens.forEach(p=>{
    html += `<tr>
      <td><b>${p.nome}</b></td>
      <td class="${p.qtd<=p.min ? 'alerta' : ''}">${p.qtd}</td>
      <td><small>${p.info||'-'}</small></td>
      <td>
        <button class="btn-qtd" onclick="ajustarEstoque(${p.id},1)">+</button>
        <button class="btn-qtd" onclick="ajustarEstoque(${p.id},-1)">-</button>
      </td>
    </tr>`;
  });
  document.getElementById('corpo-pagina').innerHTML = html + "</tbody></table>";
}

function ajustarEstoque(id, valor) {
  const item = estoque.find(i=>i.id===id);
  if(!item) return;
  item.qtd = Math.max(0, item.qtd+valor);
  localStorage.setItem('buffet_rio_db', JSON.stringify(estoque));
  if(setorAtual) renderizarSetor(); else renderizar();
}

/* --- Propostas (fluxo comercial) --- */
function openProposal(tipo) {
  currentProposal = { tipo, nivel: null, selections: [] };
  document.getElementById('navegacao').innerHTML = `<span onclick="currentProposal=null; document.getElementById('proposal-preview').innerHTML='';">In√≠cio</span> > <b>Proposta: ${tipo}</b>`;
  renderProposalEditor(tipo);
}

function renderProposalEditor(tipo) {
  const preview = document.getElementById('proposal-preview');
  const niveles = Object.keys(propostas[tipo]||{});
  let html = `<div class="card"><h2>Proposta: ${tipo}</h2>
    <div class="packages">`;
  niveles.forEach(n=>{
    html += `<div class="pkg" id="pkg-${n}" onclick="selectPackage('${n}')">${n}</div>`;
  });
  html += `</div>
    <div id="pkg-items" class="items-list"></div>
    <div class="actions">
      <button class="btn primary" onclick="confirmProposal()">Confirmar e Reservar</button>
      <button class="btn ghost" onclick="clearProposal()">Cancelar</button>
    </div>
    <div id="proposal-result"></div>
  </div>`;
  preview.innerHTML = html;
}

function selectPackage(nivel) {
  currentProposal.nivel = nivel;
  // marca visual
  document.querySelectorAll('.pkg').forEach(el=>el.classList.remove('active'));
  const el = document.getElementById('pkg-'+nivel);
  if(el) el.classList.add('active');

  // carregar items da proposta
  const items = propostas[currentProposal.tipo][nivel] || [];
  let html = `<div style="margin-top:10px"><strong>Itens sugeridos (ajuste quantidade se necess√°rio)</strong></div>`;
  html += `<div class="card" style="margin-top:8px">`;
  items.forEach(it=>{
    const prod = estoque.find(p=>p.id===it.id) || {nome:'Item n√£o encontrado', qtd:0};
    html += `<div class="item-row">
      <input type="checkbox" id="sel-${it.id}" checked onchange="toggleSelection(${it.id})">
      <div style="flex:1"><strong>${prod.nome}</strong><br><small>${prod.info||''} ‚Ä¢ Dispon√≠vel: ${prod.qtd}</small></div>
      <div><label>Qtd</label><br><input type="number" id="qty-${it.id}" min="1" value="${it.qty}" onchange="updateQty(${it.id})"></div>
    </div>`;
    // register default selection
    const exists = currentProposal.selections.find(s=>s.id===it.id);
    if(!exists) currentProposal.selections.push({id:it.id, qty:it.qty, selected:true});
  });
  html += `</div>`;
  document.getElementById('pkg-items').innerHTML = html;
}

function toggleSelection(id) {
  const s = currentProposal.selections.find(x=>x.id===id);
  if(s) s.selected = !s.selected;
  else currentProposal.selections.push({id, qty:1, selected:false});
}

function updateQty(id) {
  const v = parseInt(document.getElementById('qty-'+id).value || 0, 10);
  const s = currentProposal.selections.find(x=>x.id===id);
  if(s) s.qty = Math.max(1, v);
}

function confirmProposal() {
  if(!currentProposal || !currentProposal.nivel) {
    alert('Escolha primeiro o n√≠vel (Simples / M√©dio / Premium).');
    return;
  }
  // aplicar reservas no estoque
  const reserved = [];
  const shortages = [];
  const equipIssues = [];
  currentProposal.selections.forEach(sel=>{
    if(!sel.selected) return;
    const prod = estoque.find(p=>p.id===sel.id);
    if(!prod) return;
    // se equipamento, checar disponibilidade
    if(prod.tipo === 'equipamento') {
      const st = equipamentosStatus[prod.id];
      if(st && st.status === 'em evento') {
        equipIssues.push({nome:prod.nome, onde:st.onde});
      }
    }
    // decrementar (reservar)
    if(prod.qtd < sel.qty) {
      shortages.push({id:prod.id, nome:prod.nome, need:sel.qty - prod.qtd});
      // reservar todo lo que queda (puedes cambiar l√≥gica)
      reserved.push({id:prod.id, nome:prod.nome, reserved:prod.qtd});
      prod.qtd = 0;
    } else {
      prod.qtd = prod.qtd - sel.qty;
      reserved.push({id:prod.id, nome:prod.nome, reserved:sel.qty});
    }
  });

  // persistir estoque
  localStorage.setItem('buffet_rio_db', JSON.stringify(estoque));

  // construir vista de proposta (bonitinha)
  renderProposalCard(currentProposal, reserved, shortages, equipIssues);

  // actualizar panel do staff
  renderStaffPanel();

  // limpar sele√ß√£o atual
  currentProposal = null;
  document.getElementById('proposal-result').innerText = "Reserva realizada com sucesso.";
}

function renderProposalCard(proposta, reserved, shortages, equipIssues) {
  const container = document.getElementById('proposal-preview');
  // cria HTML da proposta
  let html = `<div style="margin-top:14px" class="card">
    <div class="proposal-card" id="proposal-card">
      <div class="proposal-header">
        <div><h2>Proposta: ${proposta.tipo}</h2><small>N√≠vel: ${proposta.nivel}</small></div>
        <div style="text-align:right"><strong>Al√©m do Bolo</strong><br><small>Gest√£o Buffet Rio</small></div>
      </div>
      <div><strong>Itens reservados:</strong></div>
      <div class="proposal-items">`;
  reserved.forEach(r=>{
    html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee">
      <div>${r.nome}</div><div><strong>${r.reserved}</strong></div>
    </div>`;
  });
  html += `</div>
      <div style="margin-top:10px">Observa√ß√µes t√©cnicas / disponibilidade:</div>
      <div style="margin-top:6px">`;
  if(shortages.length) {
    html += `<div style="color:#b91c1c"><strong>Necess√°rio comprar:</strong><ul>`;
    shortages.forEach(s=> html += `<li>${s.nome} ‚Äî falta ${s.need}</li>`);
    html += `</ul></div>`;
  } else {
    html += `<div style="color:#065f46"><strong>Estoque suficiente para os itens selecionados.</strong></div>`;
  }
  if(equipIssues.length) {
    html += `<div style="margin-top:8px;color:#92400e"><strong>Equipamentos indispon√≠veis:</strong><ul>`;
    equipIssues.forEach(e=> html += `<li>${e.nome} ‚Äî ${e.onde}</li>`);
    html += `</ul></div>`;
  }
  html += `</div>
      <div style="margin-top:12px; font-size:0.9rem; color:#475569">Data da proposta: ${new Date().toLocaleString()}</div>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px;">
      <button class="btn primary" onclick="exportProposalPNG()">Exportar imagem (PNG)</button>
      <button class="btn ghost" onclick="printProposal()">Imprimir</button>
    </div>
  </div>`;

  container.innerHTML = html;
}

function printProposal() {
  const el = document.getElementById('proposal-card');
  if(!el) return alert('Nenhuma proposta para imprimir.');
  const w = window.open('', '_blank');
  w.document.write('<html><head><title>Proposta</title></head><body>');
  w.document.write(el.outerHTML);
  w.document.write('</body></html>');
  w.document.close();
  w.print();
}

/* Exportar usando html2canvas */
function exportProposalPNG() {
  const el = document.getElementById('proposal-card');
  if(!el) return alert('Nenhuma proposta para exportar.');
  html2canvas(el, { scale: 2 }).then(canvas=>{
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = url;
    a.download = 'proposta_buffet_rio.png';
    a.click();
  }).catch(err=>{
    console.error(err);
    alert('Erro ao gerar imagem.');
  });
}

/* Painel do Staff: lista de compras e status de equipamentos */
function openStaffPanel() {
  currentProposal = null;
  document.getElementById('proposal-preview').innerHTML = '';
  renderStaffPanel(true);
}

function renderStaffPanel(openNow) {
  const staff = document.getElementById('staff-area');
  // items below min
  const needToBuy = estoque.filter(i => i.qtd < i.min).map(i=>({id:i.id,nome:i.nome,falta: i.min - i.qtd}));
  // equipamentos status
  equipamentosStatus = JSON.parse(localStorage.getItem('equip_status')) || equipamentosStatus;

  let html = `<div class="card"><h3>Painel do Staff</h3>`;
  html += `<div style="display:flex;gap:12px;align-items:flex-start">`;
  html += `<div style="flex:1">`;
  html += `<div><strong>Lista de Compras (itens abaixo do m√≠nimo)</strong></div>`;
  if(needToBuy.length) {
    html += `<ul>`;
    needToBuy.forEach(n=> html += `<li>${n.nome} ‚Äî falta ${n.falta}</li>`);
    html += `</ul>`;
  } else {
    html += `<div class="note">Nenhum item cr√≠tico no momento.</div>`;
  }
  html += `</div>`;

  html += `<div style="width:320px">`;
  html += `<div><strong>Equipamentos</strong></div>`;
  html += `<ul>`;
  Object.keys(equipamentosStatus).forEach(k=>{
    const st = equipamentosStatus[k];
    const prod = estoque.find(p=>p.id==k);
    html += `<li>${prod?prod.nome:'Equipamento '+k} ‚Äî <em>${st.status}</em> ${st.onde?'- '+st.onde:''}</li>`;
  });
  html += `</ul></div></div>`;

  html += `<div style="margin-top:10px"><small>√öltima atualiza√ß√£o: ${new Date().toLocaleString()}</small></div>`;
  html += `</div>`;
  staff.innerHTML = html;

  if(openNow) {
    // scrollear hasta panel
    staff.scrollIntoView({behavior:'smooth'});
  }
}

/* Inicial render */
renderizar();
renderStaffPanel();

</script>
</body>
</html>
