<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gest√£o de Buffet Rio - Al√©m do Bolo</title>
  <style>
    :root{--primaria:#0f172a;--destaque:#10b981;--fundo:#f8fafc;--borda:#e2e8f0}
    body{font-family:'Segoe UI',sans-serif;margin:0;display:flex;background:var(--fundo);color:#334155}
    nav{width:320px;background:var(--primaria);height:100vh;position:fixed;padding:18px;color:white;box-shadow:4px 0 10px rgba(0,0,0,.12);overflow:auto}
    nav h2{font-size:1.1rem;color:var(--destaque);margin-bottom:12px;border-bottom:1px solid #1e293b;padding-bottom:10px}
    .label-grupo{font-size:.7rem;color:#64748b;text-transform:uppercase;letter-spacing:1px;margin:12px 0 6px}
    .btn-menu{width:100%;padding:10px;margin-bottom:8px;background:#1e293b;border:0;color:white;text-align:left;border-radius:6px;cursor:pointer;transition:.2s}
    .btn-menu:hover{background:rgba(16,185,129,0.12);color:var(--destaque);font-weight:600}
    main{margin-left:360px;padding:28px;width:100%;min-height:100vh}
    .card{background:white;padding:22px;border-radius:10px;border:1px solid var(--borda);box-shadow:0 4px 6px -1px rgba(0,0,0,.06)}
    .caminho{margin-bottom:16px;font-size:.9rem;color:#64748b}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th{text-align:left;padding:12px;background:#f1f5f9;color:#475569;font-size:.85rem}
    td{padding:12px;border-bottom:1px solid var(--borda)}
    .linha-clicavel{cursor:pointer;transition:.2s}
    .linha-clicavel:hover{background:#f8fafc}
    .btn-qtd{padding:6px 10px;border:1px solid var(--borda);background:white;cursor:pointer;border-radius:4px}
    .alerta{color:#ef4444;font-weight:bold}
    .packages{display:flex;gap:12px;margin-top:14px}
    .pkg{padding:12px;border-radius:8px;background:#f8fafc;border:1px solid var(--borda);cursor:pointer;flex:1;text-align:center}
    .pkg.active{background:var(--destaque);color:white;font-weight:700}
    .items-list{margin-top:14px}
    .item-row{display:flex;gap:12px;align-items:center;padding:8px;border-bottom:1px dashed var(--borda)}
    .actions{margin-top:14px;display:flex;gap:8px}
    .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
    .btn.primary{background:var(--destaque);color:white}
    .btn.ghost{background:white;border:1px solid var(--borda)}
    #proposal-preview{margin-top:18px}
    .proposal-card{width:700px;padding:22px;border-radius:10px;background:linear-gradient(180deg,#fff,#f9fafb);color:#0f172a;box-shadow:0 10px 30px rgba(2,6,23,.12)}
    .note{font-size:.9rem;color:#7b341e}
    input.small{width:100%;padding:6px;border:1px solid var(--borda);border-radius:6px}
    /* removed hover preview styles (no hover preview) */
  </style>

  <script>
    // Attempt to unregister old service workers early to avoid "Content unavailable. Resource was not cached"
    if ('serviceWorker' in navigator) {
      try {
        navigator.serviceWorker.getRegistrations().then(function(regs){
          regs.forEach(function(r){ try{ r.unregister(); }catch(e){} });
        }).catch(function(){});
        navigator.serviceWorker.getRegistration().then(function(r){ if(r) try{ r.unregister(); }catch(e){} }).catch(function(){});
      } catch(e) { console.warn('SW unregister early failed', e); }
    }
  </script>
</head>
<body>
  <nav id="left-nav">
    <h2>Al√©m do Bolo</h2>

    <div class="label-grupo">Armazenamento</div>
    <button class="btn-menu" data-type="categoria" data-key="C√¢mara">üì¶ Itens de C√¢mara</button>
    <button class="btn-menu" data-type="categoria" data-key="Freezer">‚ùÑÔ∏è Itens de Freezer</button>

    <div class="label-grupo">Operacional</div>
    <button class="btn-menu" data-type="categoria" data-key="Equipamento">‚ö° Equipamentos</button>
    <button class="btn-menu" data-type="categoria" data-key="Material">üçΩÔ∏è Materiais </button>

    <div class="label-grupo">Comercial - Propostas</div>
    <button class="btn-menu" data-type="proposta" data-key="Caf√© Manh√£">‚òï Caf√© Manh√£</button>
    <button class="btn-menu" data-type="proposta" data-key="Coffee Meal">ü•™ Coffee Break</button>
    <button class="btn-menu" data-type="proposta" data-key="Almo√ßo">üçõ Almo√ßo</button>
    <button class="btn-menu" data-type="proposta" data-key="Janta">üçΩÔ∏è Jantar</button>
    <button class="btn-menu" data-type="proposta" data-key="Coquetel">üç∏ Coquetelaria</button>

    <div class="label-grupo" style="margin-top:12px">Admin</div>
    <button class="btn-menu" data-type="admin" data-key="staff">üõü Painel do Staff</button>
  </nav>

  <main>
    <div id="navegacao" class="caminho"></div>

    <div class="card" id="main-card">
      <h1 id="titulo-pagina">Selecione uma op√ß√£o ao lado</h1>
      <div id="corpo-pagina">Passe o mouse ou clique nas op√ß√µes √† esquerda para ver o conte√∫do correspondente.</div>
    </div>

    <div id="proposal-preview"></div>
    <div id="staff-area"></div>
  </main>

  <!-- NO hover-preview element: preview-on-hover removed as requested -->

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', function(){
    try {
      // --- initial data in localStorage if absent ---
      var estoque = JSON.parse(localStorage.getItem('buffet_rio_db')) || [
        { id:1, cat:"C√¢mara", local:"C√¢mara Fria 1", setor:"Estante A", nome:"Carne Bovina", qtd:25, min:10, info:"-2¬∞C", tipo:"ingrediente" },
        { id:2, cat:"C√¢mara", local:"C√¢mara Fria 1", setor:"Estante B", nome:"Latic√≠nios", qtd:8, min:15, info:"Validade curta", tipo:"ingrediente" },
        { id:3, cat:"Freezer", local:"Freezer Vertical 1", setor:"Gaveta 1 - F1", nome:"Polpas de Fruta", qtd:40, min:10, info:"Freezer 1", tipo:"ingrediente" },
        { id:6, cat:"Freezer", local:"Freezer Horizontal 2", setor:"Gaveta 1 - F2", nome:"Polpas de Fruta (F2)", qtd:20, min:10, info:"Freezer 2", tipo:"ingrediente" },
        { id:4, cat:"Equipamento", local:"Cozinha Central", setor:"Bancada", nome:"Fritadeira El√©trica", qtd:2, min:1, info:"Voltagem:220V", tipo:"equipamento" },
        { id:5, cat:"Material", local:"Dep√≥sito", setor:"Prateleira 4", nome:"Pratos Rasos", qtd:150, min:100, info:"Porcelana Branca", tipo:"material" }
      ];
      localStorage.setItem('buffet_rio_db', JSON.stringify(estoque));
      var equipamentosStatus = JSON.parse(localStorage.getItem('equip_status')) || { 4:{status:"em evento",onde:"Casamento - Praia"} };
      localStorage.setItem('equip_status', JSON.stringify(equipamentosStatus));

      // UI state
      var catAtual = '';
      var setorAtual = '';
      var currentProposal = null;

      // proposals
      var propostas = {
        "Caf√© Manh√£": { "B√°sico":[{id:5,qty:30},{id:3,qty:10}], "Top":[{id:5,qty:50},{id:3,qty:20},{id:2,qty:10}], "Premium":[{id:5,qty:80},{id:3,qty:30},{id:2,qty:20},{id:1,qty:10}] },
        "Coffee Meal": { "B√°sico":[{id:5,qty:20},{id:3,qty:15}], "Top":[{id:5,qty:40},{id:3,qty:30},{id:2,qty:10}], "Premium":[{id:5,qty:60},{id:3,qty:40},{id:2,qty:20},{id:1,qty:15}] },
        "Almo√ßo": { "B√°sico":[{id:1,qty:10},{id:5,qty:40}], "Top":[{id:1,qty:20},{id:5,qty:60},{id:3,qty:20}], "Premium":[{id:1,qty:35},{id:5,qty:80},{id:3,qty:30}] },
        "Janta": { "B√°sico":[{id:1,qty:12},{id:5,qty:40}], "Top":[{id:1,qty:25},{id:5,qty:70},{id:3,qty:25}], "Premium":[{id:1,qty:40},{id:5,qty:100},{id:3,qty:40}] },
        "Coquetelaria": { "B√°sico":[{id:5,qty:20},{id:3,qty:10}], "Top":[{id:5,qty:40},{id:3,qty:20}], "Premium":[{id:5,qty:60},{id:3,qty:40},{id:4,qty:1}] }
      };

      // helpers
      function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
      function baseName(nome){ return String(nome).replace(/\s*\(.*\)\s*/g,'').trim().toLowerCase(); }
      function totalAvailableFor(id){ var prod = estoque.find(function(p){ return p.id===id; }); if(!prod) return 0; var base = baseName(prod.nome); return estoque.filter(function(p){ return baseName(p.nome)===base; }).reduce(function(s,p){ return s + p.qtd; },0); }

      function reserveAcrossLocationsProportional(id, qty){
        var main = estoque.find(function(p){ return p.id===id; });
        if(!main) return { allocations:[], shortage:qty };
        var base = baseName(main.nome);
        var candidates = estoque.filter(function(p){ return baseName(p.nome)===base && p.qtd>0; });
        var totalAvailable = candidates.reduce(function(s,c){ return s + c.qtd; }, 0);
        if(totalAvailable <= 0) return { allocations:[], shortage:qty };
        var provisional = candidates.map(function(c){ return { c:c, take:0 }; });
        var allocatedSum = 0;
        provisional.forEach(function(p){
          var share = Math.floor(qty * (p.c.qtd / totalAvailable));
          var take = Math.min(share, p.c.qtd);
          p.take = take;
          allocatedSum += take;
        });
        var remaining = qty - allocatedSum;
        provisional.sort(function(a,b){ return (b.c.qtd - a.c.qtd) - (a.c.qtd - b.c.qtd); });
        for(var i=0;i<provisional.length && remaining>0;i++){
          var p = provisional[i];
          var can = Math.min(remaining, p.c.qtd - p.take);
          if(can>0){ p.take += can; remaining -= can; }
        }
        if(remaining>0){
          for(i=0;i<provisional.length && remaining>0;i++){
            var p2 = provisional[i];
            var can2 = Math.min(remaining, p2.c.qtd - p2.take);
            if(can2>0){ p2.take += can2; remaining -= can2; }
          }
        }
        var allocations = [];
        provisional.forEach(function(p){
          if(p.take>0){ p.c.qtd -= p.take; allocations.push({ id:p.c.id, nome:p.c.nome, local:p.c.local, reserved:p.take }); }
        });
        var shortage = Math.max(0, qty - allocations.reduce(function(s,a){ return s + a.reserved; },0));
        return { allocations: allocations, shortage: shortage };
      }

      // breadcrumbs
      function setBreadcrumb(parts){
        var nav = document.getElementById('navegacao'); nav.innerHTML = '';
        parts.forEach(function(p,i){
          var span = document.createElement('span'); span.textContent = p.text;
          if(p.action){ span.style.cursor = 'pointer'; span.addEventListener('click', p.action); }
          nav.appendChild(span);
          if(i < parts.length-1) nav.appendChild(document.createTextNode(' > '));
        });
      }

      function showDefaultMain(){
        setBreadcrumb([]);
        document.getElementById('titulo-pagina').textContent = 'Selecione uma op√ß√£o ao lado';
        document.getElementById('corpo-pagina').textContent = 'Clique nas op√ß√µes √† esquerda para ver o conte√∫do correspondente.';
        document.getElementById('proposal-preview').innerHTML = '';
        document.getElementById('staff-area').innerHTML = '';
      }

      function renderCategoria(cat){
        catAtual = cat; setorAtual = '';
        if(cat === 'Freezer'){
          var freezers = [];
          estoque.forEach(function(i){ if(i.cat==='Freezer' && freezers.indexOf(i.local)===-1) freezers.push(i.local); });
          setBreadcrumb([{text:'In√≠cio', action:function(){ catAtual=''; showDefaultMain(); }}, {text:cat}]);
          document.getElementById('titulo-pagina').textContent = 'Freezers';
          var tbl = document.createElement('table');
          tbl.innerHTML = '<thead><tr><th>Freezer</th><th>Qtd Total</th></tr></thead><tbody></tbody>';
          freezers.forEach(function(f){
            var total = estoque.filter(function(p){ return p.local===f; }).reduce(function(s,p){ return s + p.qtd; },0);
            var tr = document.createElement('tr'); tr.className = 'linha-clicavel';
            tr.innerHTML = '<td>‚ùÑÔ∏è <b>' + escapeHtml(f) + '</b></td><td>' + total + '</td>';
            tr.addEventListener('click', function(){ abrirFreezer(f); });
            tbl.querySelector('tbody').appendChild(tr);
          });
          var corpo = document.getElementById('corpo-pagina'); corpo.innerHTML = ''; corpo.appendChild(tbl);
        } else {
          setBreadcrumb([{text:'In√≠cio', action:function(){ catAtual=''; showDefaultMain(); }}, {text:cat}]);
          document.getElementById('titulo-pagina').textContent = 'Setores da ' + cat;
          var setores = []; estoque.forEach(function(i){ if(i.cat===cat && setores.indexOf(i.setor)===-1) setores.push(i.setor); });
          var table = document.createElement('table'); table.innerHTML = '<thead><tr><th>Setor / Localiza√ß√£o</th><th>Qtd Total</th></tr></thead><tbody></tbody>';
          setores.forEach(function(s){
            var total = estoque.filter(function(i){ return i.cat===cat && i.setor===s; }).reduce(function(a,b){ return a + b.qtd; },0);
            var tr = document.createElement('tr'); tr.className = 'linha-clicavel';
            tr.innerHTML = '<td>üìÇ Setor: <b>' + escapeHtml(s) + '</b></td><td>' + total + '</td>';
            tr.addEventListener('click', function(){ abrirSetor(s); });
            table.querySelector('tbody').appendChild(tr);
          });
          var corpo = document.getElementById('corpo-pagina'); corpo.innerHTML = ''; corpo.appendChild(table);
        }
      }

      function abrirFreezer(local){
        setorAtual = local; catAtual = 'Freezer';
        setBreadcrumb([{text:'In√≠cio', action:function(){ catAtual=''; showDefaultMain(); }},{text:catAtual, action:function(){ renderCategoria(catAtual); }},{text:setorAtual}]);
        document.getElementById('titulo-pagina').textContent = 'Itens em: ' + setorAtual;
        var itens = estoque.filter(function(i){ return i.cat==='Freezer' && i.local===local; });
        renderItemsTable(itens);
      }

      function abrirSetor(s){
        setorAtual = s;
        setBreadcrumb([{text:'In√≠cio', action:function(){ catAtual=''; showDefaultMain(); }},{text:catAtual, action:function(){ renderCategoria(catAtual); }},{text:setorAtual}]);
        document.getElementById('titulo-pagina').textContent = 'Itens em: ' + setorAtual;
        var itens = estoque.filter(function(i){ return i.cat===catAtual && i.setor===setorAtual; });
        renderItemsTable(itens);
      }

      function renderItemsTable(itens){
        var table = document.createElement('table'); table.innerHTML = '<thead><tr><th>Item</th><th>Qtd</th><th>Info T√©cnica</th><th>Movimenta√ß√£o</th></tr></thead><tbody></tbody>';
        itens.forEach(function(p){
          var tr = document.createElement('tr');
          tr.innerHTML = '<td><b>' + escapeHtml(p.nome) + '</b></td><td class="' + (p.qtd<=p.min ? 'alerta' : '') + '">' + p.qtd + '</td><td><small>' + escapeHtml(p.info||'-') + '</small></td><td></td>';
          var tdActions = tr.querySelector('td:last-child');
          var bInc = document.createElement('button'); bInc.className='btn-qtd'; bInc.textContent = '+'; bInc.addEventListener('click', function(){ ajustarEstoque(p.id,1); });
          var bDec = document.createElement('button'); bDec.className='btn-qtd'; bDec.textContent='-'; bDec.addEventListener('click', function(){ ajustarEstoque(p.id,-1); });
          tdActions.appendChild(bInc); tdActions.appendChild(bDec);
          table.querySelector('tbody').appendChild(tr);
        });
        var corpo = document.getElementById('corpo-pagina'); corpo.innerHTML = ''; corpo.appendChild(table);
      }

      // Important: updated ajustarEstoque to re-render the correct view after change
      function ajustarEstoque(id, valor){
        var item = estoque.find(function(i){ return i.id===id; });
        if(!item) return;
        item.qtd = Math.max(0, item.qtd + valor);
        localStorage.setItem('buffet_rio_db', JSON.stringify(estoque));
        // re-render current view appropriately
        if(catAtual && setorAtual){
          if(catAtual === 'Freezer'){
            // setorAtual stores the freezer local in this flow
            abrirFreezer(setorAtual);
          } else {
            abrirSetor(setorAtual);
          }
        } else {
          renderizar();
        }
      }

      function renderProposalEditor(tipo){
        currentProposal = { tipo: tipo, nivel: null, selections: [] };
        setBreadcrumb([{text:'In√≠cio', action:function(){ currentProposal=null; showDefaultMain(); }}, {text:'Proposta: ' + tipo}]);
        var container = document.createElement('div'); container.className='card';
        var h = document.createElement('h2'); h.textContent = 'Proposta: ' + tipo; container.appendChild(h);
        var packDiv = document.createElement('div'); packDiv.className='packages';
        var niveles = Object.keys(propostas[tipo]||{});
        niveles.forEach(function(n){
          var div = document.createElement('div'); div.className='pkg'; div.textContent = n; div.addEventListener('click', function(){ selectPackage(n); });
          packDiv.appendChild(div);
        });
        container.appendChild(packDiv);
        var itemsHolder = document.createElement('div'); itemsHolder.id = 'pkg-items'; itemsHolder.className='items-list';
        container.appendChild(itemsHolder);
        var actions = document.createElement('div'); actions.className='actions';
        var confirm = document.createElement('button'); confirm.className='btn primary'; confirm.textContent='Confirmar e Reservar'; confirm.addEventListener('click', confirmProposal);
        var cancel = document.createElement('button'); cancel.className='btn ghost'; cancel.textContent='Cancelar'; cancel.addEventListener('click', function(){ currentProposal=null; document.getElementById('proposal-preview').innerHTML=''; showDefaultMain(); });
        actions.appendChild(confirm); actions.appendChild(cancel);
        container.appendChild(actions);
        var corpo = document.getElementById('corpo-pagina'); corpo.innerHTML = ''; corpo.appendChild(container);
      }

      function selectPackage(nivel){
        currentProposal.nivel = nivel;
        Array.prototype.forEach.call(document.querySelectorAll('.pkg'), function(el){ el.classList.toggle('active', el.textContent===nivel); });
        var items = propostas[currentProposal.tipo][nivel] || [];
        currentProposal.selections = items.map(function(it){ return { id: it.id, qty: it.qty, selected:true }; });
        var holder = document.getElementById('pkg-items'); holder.innerHTML = '';
        var card = document.createElement('div'); card.className='card';
        items.forEach(function(it){
          var prod = estoque.filter(function(p){ return p.id===it.id; })[0] || { nome:'Item n√£o encontrado', qtd:0, info:'' };
          var row = document.createElement('div'); row.className='item-row';
          var cb = document.createElement('input'); cb.type='checkbox'; cb.checked=true; cb.dataset.id = it.id; cb.addEventListener('change', function(){ var id = parseInt(cb.dataset.id,10); var s = currentProposal.selections.find(function(x){ return x.id===id; }); if(s) s.selected = cb.checked; });
          var info = document.createElement('div'); info.style.flex='1'; info.innerHTML = '<strong>' + escapeHtml(prod.nome) + '</strong><br><small>' + escapeHtml(prod.info||'') + ' ‚Ä¢ Dispon√≠vel total: ' + totalAvailableFor(it.id) + '</small>';
          var qtyWrap = document.createElement('div'); qtyWrap.innerHTML = '<label>Qtd</label><br>';
          var inp = document.createElement('input'); inp.type='number'; inp.value = it.qty; inp.min = 1; inp.dataset.id = it.id; inp.className='qty-input';
          inp.addEventListener('change', function(){ var id = parseInt(inp.dataset.id,10); var s = currentProposal.selections.find(function(x){ return x.id===id; }); if(s) s.qty = Math.max(1, parseInt(inp.value,10) || 1); });
          qtyWrap.appendChild(inp);
          row.appendChild(cb); row.appendChild(info); row.appendChild(qtyWrap);
          card.appendChild(row);
        });
        holder.appendChild(card);
      }

      function confirmProposal(){
        if(!currentProposal || !currentProposal.nivel){ alert('Escolha primeiro o n√≠vel (B√°sico / Top / Premium).'); return; }
        var finalAllocations = [], shortages = [], equipIssues = [];
        currentProposal.selections.forEach(function(sel){
          if(!sel.selected) return;
          var prod = estoque.filter(function(p){ return p.id===sel.id; })[0];
          if(!prod) return;
          if(prod.tipo === 'equipamento'){
            var st = equipamentosStatus[prod.id];
            if(st && st.status==='em evento'){ equipIssues.push({nome:prod.nome, onde:st.onde}); return; }
          }
          var res = reserveAcrossLocationsProportional(sel.id, sel.qty);
          res.allocations.forEach(function(a){ finalAllocations.push(a); });
          if(res.shortage > 0) shortages.push({ id: prod.id, nome: prod.nome, need: res.shortage });
        });
        localStorage.setItem('buffet_rio_db', JSON.stringify(estoque));
        var timestamp = new Date().toISOString();
        var lastProposal = { tipo: currentProposal.tipo, nivel: currentProposal.nivel, allocations: finalAllocations, shortages: shortages, equipIssues: equipIssues, timestamp: timestamp };
        localStorage.setItem('last_proposal', JSON.stringify(lastProposal));
        renderClientProposalCard(lastProposal);
        renderStaffPanel();
        var staffPhone = localStorage.getItem('staff_phone') || '';
        if(staffPhone){ var msg = buildWhatsAppMessage(lastProposal); window.open('https://wa.me/' + encodeURIComponent(staffPhone) + '?text=' + encodeURIComponent(msg), '_blank'); }
        else { var el = document.getElementById('proposal-result'); if(el) el.textContent = "Reserva realizada. Configure o n√∫mero do staff para enviar notifica√ß√£o por WhatsApp."; }
        currentProposal = null;
        var pr = document.getElementById('proposal-result'); if(pr) pr.textContent = "Reserva realizada com sucesso.";
      }

      function buildWhatsAppMessage(proposal){
        var lines = [];
        lines.push('Proposta confirmada: ' + proposal.tipo + ' ‚Äî N√≠vel: ' + proposal.nivel);
        lines.push('Data: ' + new Date(proposal.timestamp).toLocaleString());
        lines.push('');
        if(proposal.allocations.length){
          lines.push('Itens reservados (origem):');
          var grouped = {};
          proposal.allocations.forEach(function(a){ (grouped[a.nome] = grouped[a.nome] || []).push(a); });
          Object.keys(grouped).forEach(function(nome){
            lines.push('- ' + nome + ':');
            grouped[nome].forEach(function(g){ lines.push('   ‚Ä¢ ' + g.reserved + ' ‚Äî ' + g.local); });
          });
        } else lines.push('Nenhum item reservado.');
        if(proposal.shortages && proposal.shortages.length){ lines.push(''); lines.push('Faltas / Necess√°rio comprar:'); proposal.shortages.forEach(function(s){ lines.push('- ' + s.nome + ' ‚Äî falta ' + s.need); }); }
        if(proposal.equipIssues && proposal.equipIssues.length){ lines.push(''); lines.push('Equipamentos indispon√≠veis:'); proposal.equipIssues.forEach(function(e){ lines.push('- ' + e.nome + ' ‚Äî ' + e.onde); }); }
        lines.push(''); lines.push('Ver painel do staff para detalhes.');
        return lines.join('\n');
      }

      function renderClientProposalCard(proposal){
        var container = document.getElementById('proposal-preview'); container.innerHTML = '';
        var totals = {};
        proposal.allocations.forEach(function(a){ totals[a.nome] = (totals[a.nome] || 0) + a.reserved; });
        var div = document.createElement('div'); div.className='card';
        var inner = '<div class="proposal-card" id="proposal-card"><div class="proposal-header"><div><h2>Proposta: ' + escapeHtml(proposal.tipo) + '</h2><small>N√≠vel: ' + escapeHtml(proposal.nivel) + '</small></div><div style="text-align:right"><strong>Al√©m do Bolo</strong><br><small>Gest√£o Buffet Rio</small></div></div><div><strong>Itens reservados:</strong></div><div class="proposal-items">';
        if(Object.keys(totals).length === 0) inner += '<div><em>Nenhum item reservado (verificar disponibilidade).</em></div>';
        else Object.keys(totals).forEach(function(nome){ inner += '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee"><div>' + escapeHtml(nome) + '</div><div><strong>' + totals[nome] + '</strong></div></div>'; });
        inner += '</div><div style="margin-top:12px">Observa√ß√µes:</div><div style="margin-top:6px">';
        if(proposal.shortages.length) inner += '<div style="color:#b91c1c"><strong>Alguns itens em falta ‚Äî equipe ser√° notificada.</strong></div>';
        else inner += '<div style="color:#065f46"><strong>Estoque suficiente para os itens selecionados.</strong></div>';
        inner += '</div><div style="margin-top:12px; font-size:0.9rem; color:#475569">Data da proposta: ' + new Date(proposal.timestamp).toLocaleString() + '</div></div>';
        inner += '<div style="margin-top:12px; display:flex; gap:8px;"><button class="btn primary" onclick="exportProposalPNG()">Exportar imagem (PNG)</button><button class="btn ghost" onclick="printProposal()">Imprimir</button></div>';
        div.innerHTML = inner; container.appendChild(div);
      }

      function renderStaffPanel(openNow){
        var staff = document.getElementById('staff-area'); staff.innerHTML='';
        var needToBuy = estoque.filter(function(i){ return i.qtd < i.min; }).map(function(i){ return { id:i.id, nome:i.nome, falta:i.min - i.qtd, setor:i.setor }; });
        equipamentosStatus = JSON.parse(localStorage.getItem('equip_status')) || equipamentosStatus;
        var lastProposal = JSON.parse(localStorage.getItem('last_proposal') || 'null');
        var div = document.createElement('div'); div.className='card';
        var h3 = document.createElement('h3'); h3.textContent = 'Painel do Staff'; div.appendChild(h3);
        var flex = document.createElement('div'); flex.style.display='flex'; flex.style.gap='12px'; flex.style.alignItems='flex-start';
        var left = document.createElement('div'); left.style.flex='1';
        left.innerHTML = '<div><strong>Lista de Compras (itens abaixo do m√≠nimo)</strong></div>';
        if(needToBuy.length){ var ul = document.createElement('ul'); needToBuy.forEach(function(n){ var li = document.createElement('li'); li.innerHTML = escapeHtml(n.nome) + ' ‚Äî falta ' + n.falta + ' (' + escapeHtml(n.setor) + ')'; ul.appendChild(li); }); left.appendChild(ul); }
        else { var note = document.createElement('div'); note.className='note'; note.textContent = 'Nenhum item cr√≠tico no momento.'; left.appendChild(note); }
        flex.appendChild(left);
        var right = document.createElement('div'); right.style.width='360px';
        var equipHtml = '<div><strong>Equipamentos</strong></div><ul>';
        Object.keys(equipamentosStatus).forEach(function(k){ var st = equipamentosStatus[k]; var prod = estoque.filter(function(p){ return p.id==k; })[0]; equipHtml += '<li>' + (prod?escapeHtml(prod.nome):'Equipamento '+k) + ' ‚Äî <em>' + escapeHtml(st.status) + '</em>' + (st.onde? ' - ' + escapeHtml(st.onde) : '') + '</li>'; });
        equipHtml += '</ul>';
        right.innerHTML = equipHtml + '<div style="margin-top:8px"><strong>N√∫mero do staff (WhatsApp)</strong><input id="staff-phone" class="small" placeholder="5511999999999" value="' + escapeHtml(localStorage.getItem('staff_phone') || '') + '"><div style="display:flex;gap:6px;margin-top:6px"><button class="btn primary" id="save-phone">Salvar n√∫mero</button><button class="btn ghost" id="send-last">Enviar √∫ltima proposta por WhatsApp</button></div></div>';
        flex.appendChild(right);
        div.appendChild(flex);
        var lastDiv = document.createElement('div'); lastDiv.style.marginTop='10px'; lastDiv.innerHTML = '<strong>√öltima Proposta (detalhes de origem)</strong>';
        if(lastProposal){ lastDiv.innerHTML += '<div style="font-size:0.9rem;margin-top:6px"><em>' + new Date(lastProposal.timestamp).toLocaleString() + '</em></div>'; if(lastProposal.allocations.length){ Object.keys(lastProposal.allocations.reduce(function(acc,a){ acc[a.nome]=true; return acc; },{})).forEach(function(nome){ lastDiv.innerHTML += '<div style="margin-top:6px"><strong>' + escapeHtml(nome) + '</strong></div>'; }); if(lastProposal.shortages.length){ lastDiv.innerHTML += '<div style="margin-top:8px;color:#b91c1c"><strong>Faltas:</strong><ul>'; lastProposal.shortages.forEach(function(s){ lastDiv.innerHTML += '<li>' + escapeHtml(s.nome) + ' ‚Äî falta ' + s.need + '</li>'; }); lastDiv.innerHTML += '</ul></div>'; } if(lastProposal.equipIssues && lastProposal.equipIssues.length){ lastDiv.innerHTML += '<div style="margin-top:8px;color:#92400e"><strong>Equipamentos indispon√≠veis:</strong><ul>'; lastProposal.equipIssues.forEach(function(e){ lastDiv.innerHTML += '<li>' + escapeHtml(e.nome) + ' ‚Äî ' + escapeHtml(e.onde) + '</li>'; }); lastDiv.innerHTML += '</ul></div>'; } } else lastDiv.innerHTML += '<div style="margin-top:6px"><em>Nenhuma aloca√ß√£o.</em></div>'; } else lastDiv.innerHTML += '<div style="margin-top:6px"><em>Nenhuma proposta registrada ainda.</em></div>';
        div.appendChild(lastDiv); div.innerHTML += '<div style="margin-top:10px"><small>√öltima atualiza√ß√£o: ' + new Date().toLocaleString() + '</small></div>';
        staff.appendChild(div);
        document.getElementById('save-phone').addEventListener('click', saveStaffPhone);
        document.getElementById('send-last').addEventListener('click', sendLastProposalWhatsApp);
        if(openNow) staff.scrollIntoView({behavior:'smooth'});
      }

      function saveStaffPhone(){ var el = document.getElementById('staff-phone'); if(!el) return; var v = (el.value||'').trim(); if(!v){ alert('Informe o telefone no formato internacional sem sinais (ex: 5511999999999)'); return; } localStorage.setItem('staff_phone', v); alert('N√∫mero do staff salvo.'); }
      function sendLastProposalWhatsApp(){ var staffPhone = localStorage.getItem('staff_phone') || ''; if(!staffPhone){ alert('Configure primeiro o n√∫mero do staff.'); return; } var lastProposal = JSON.parse(localStorage.getItem('last_proposal') || 'null'); if(!lastProposal){ alert('N√£o h√° proposta para enviar.'); return; } var msg = buildWhatsAppMessage(lastProposal); window.open('https://wa.me/' + encodeURIComponent(staffPhone) + '?text=' + encodeURIComponent(msg), '_blank'); }

      function printProposal(){ var el = document.getElementById('proposal-card'); if(!el) return alert('Nenhuma proposta para imprimir.'); var w = window.open('','_blank'); w.document.write('<html><head><title>Proposta</title></head><body>'); w.document.write(el.outerHTML); w.document.write('</body></html>'); w.document.close(); w.print(); }
      window.exportProposalPNG = function(){ var el = document.getElementById('proposal-card'); if(!el) return alert('Nenhuma proposta para exportar.'); html2canvas(el, { scale:2 }).then(function(canvas){ var url = canvas.toDataURL('image/png'); var a = document.createElement('a'); a.href = url; a.download = 'proposta_buffet_rio.png'; a.click(); }).catch(function(){ alert('Erro ao gerar imagem.'); }); };

      function renderizar(){ if(catAtual) renderCategoria(catAtual); else showDefaultMain(); }

      // left menu click delegation (no hover preview)
      document.getElementById('left-nav').addEventListener('click', function(e){
        var btn = e.target.closest('.btn-menu'); if(!btn) return;
        var type = btn.getAttribute('data-type'), key = btn.getAttribute('data-key');
        if(type==='categoria') renderCategoria(key);
        else if(type==='proposta') renderProposalEditor(key);
        else if(type==='admin') renderStaffPanel(true);
      });

      // init
      showDefaultMain();
      renderizar();

      // expose minimal API for debugging from console
      window.app = { renderizar: renderizar, renderCategoria: renderCategoria, estoque: estoque };
    } catch(err) {
      console.error('Execution error in app script:', err);
      document.getElementById('titulo-pagina').textContent = 'Ocorreu um erro ao carregar a aplica√ß√£o';
      document.getElementById('corpo-pagina').textContent = 'Abra o Console (F12) para ver detalhes. Se o erro persistir, limpe o cache e desregistre qualquer Service Worker.';
    }
  }); // DOMContentLoaded end
  </script>
</body>
</html>
