<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gest√£o de Buffet Rio - Al√©m do Bolo</title>
  <style>
    :root { --primaria:#0f172a; --destaque:#10b981; --fundo:#f8fafc; --borda:#e2e8f0; }
    body { font-family: 'Segoe UI', sans-serif; margin:0; display:flex; background:var(--fundo); color:#334155; }
    nav { width:320px; background:var(--primaria); height:100vh; position:fixed; padding:25px; color:white; box-shadow:4px 0 10px rgba(0,0,0,.12); }
    nav h2 { font-size:1.1rem; color:var(--destaque); margin-bottom:18px; border-bottom:1px solid #1e293b; padding-bottom:12px; }
    .label-grupo { font-size:0.7rem; color:#64748b; text-transform:uppercase; letter-spacing:1px; margin:16px 0 8px; }
    .btn-menu { width:100%; padding:10px; margin-bottom:8px; background:#1e293b; border:none; color:white; text-align:left; border-radius:6px; cursor:pointer; transition:.2s; }
    .btn-menu:hover { background:var(--destaque); color:#0f172a; font-weight:bold; }
    main { margin-left:360px; padding:28px; width:100%; }
    .card { background:white; padding:22px; border-radius:10px; border:1px solid var(--borda); box-shadow:0 4px 6px -1px rgba(0,0,0,.06); }
    .caminho { margin-bottom:16px; font-size:.9rem; color:#64748b; cursor:pointer; }
    .caminho span:hover { color:var(--destaque); text-decoration:underline; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th { text-align:left; padding:12px; background:#f1f5f9; color:#475569; font-size:.85rem; }
    td { padding:12px; border-bottom:1px solid var(--borda); }
    .linha-clicavel { cursor:pointer; transition:.2s; }
    .linha-clicavel:hover { background:#f8fafc; }
    .btn-qtd { padding:6px 10px; border:1px solid var(--borda); background:white; cursor:pointer; border-radius:4px; }
    .alerta { color:#ef4444; font-weight:bold; }
    /* Proposta / UI extra */
    .packages { display:flex; gap:12px; margin-top:14px; }
    .pkg { padding:12px; border-radius:8px; background:#f8fafc; border:1px solid var(--borda); cursor:pointer; flex:1; text-align:center; }
    .pkg.active { background:var(--destaque); color:white; font-weight:700; }
    .items-list { margin-top:14px; }
    .item-row { display:flex; gap:12px; align-items:center; padding:8px; border-bottom:1px dashed var(--borda); }
    .item-row input[type="number"] { width:70px; padding:6px; border:1px solid var(--borda); border-radius:6px; }
    .actions { margin-top:14px; display:flex; gap:8px; }
    .btn { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; }
    .btn.primary { background:var(--destaque); color:white; }
    .btn.ghost { background:white; border:1px solid var(--borda); }
    /* Proposta visual */
    #proposal-preview { margin-top:18px; }
    .proposal-card { width:700px; padding:22px; border-radius:10px; background:linear-gradient(180deg,#ffffff, #f9fafb); color:#0f172a; box-shadow:0 10px 30px rgba(2,6,23,.12); }
    .proposal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .proposal-items { margin-top:8px; }
    .staff-panel { margin-top:18px; padding:12px; background:#fff7ed; border-radius:8px; border:1px solid #fde3c6; }
    .note { font-size:.9rem; color:#7b341e; }
    input.small { width:100%; padding:6px; border:1px solid var(--borda); border-radius:6px; }
  </style>
</head>
<body>

<nav>
  <h2>BUFFET RIO PRO</h2>

  <div class="label-grupo">Armazenamento</div>
  <button class="btn-menu" onclick="trocarCategoria('C√¢mara')">üì¶ Itens de C√¢mara</button>
  <button class="btn-menu" onclick="trocarCategoria('Freezer')">‚ùÑÔ∏è Itens de Freezer</button>

  <div class="label-grupo">Operacional</div>
  <button class="btn-menu" onclick="trocarCategoria('Equipamento')">‚ö° Equipamentos</button>
  <button class="btn-menu" onclick="trocarCategoria('Material')">üçΩÔ∏è Materiais / Lou√ßas</button>

  <div class="label-grupo">Comercial - Propostas</div>
  <button class="btn-menu" onclick="openProposal('Caf√© Manh√£')">‚òï Caf√© Manh√£</button>
  <button class="btn-menu" onclick="openProposal('Coffee Meal')">ü•™ Coffee Meal</button>
  <button class="btn-menu" onclick="openProposal('Almo√ßo')">üçõ Almo√ßo</button>
  <button class="btn-menu" onclick="openProposal('Janta')">üçΩÔ∏è Janta</button>
  <button class="btn-menu" onclick="openProposal('Coquetelaria')">üç∏ Coquetelaria</button>

  <div class="label-grupo" style="margin-top:22px">Admin</div>
  <button class="btn-menu" onclick="openStaffPanel()">üõü Painel do Staff</button>
</nav>

<main>
  <div id="navegacao" class="caminho"></div>

  <div class="card">
    <h1 id="titulo-pagina">Selecione uma op√ß√£o ao lado</h1>
    <div id="corpo-pagina">Escolha uma categoria para gerenciar o estoque ou criar uma proposta.</div>
  </div>

  <div id="proposal-preview"></div>
  <div id="staff-area"></div>
</main>

<!-- html2canvas para exportar a proposta como imagem -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
/* --- Dados iniciais (localStorage) --- */
let estoque = JSON.parse(localStorage.getItem('buffet_rio_db')) || [
  { id:1, cat:"C√¢mara", local:"C√¢mara Fria 1", setor:"Estante A", nome:"Carne Bovina", qtd:25, min:10, info:"-2¬∞C", tipo:"ingrediente" },
  { id:2, cat:"C√¢mara", local:"C√¢mara Fria 1", setor:"Estante B", nome:"Latic√≠nios", qtd:8, min:15, info:"Validade curta", tipo:"ingrediente" },
  { id:3, cat:"Freezer", local:"Freezer Vertical 1", setor:"Gaveta 1 - F1", nome:"Polpas de Fruta", qtd:40, min:10, info:"Freezer 1", tipo:"ingrediente" },
  { id:6, cat:"Freezer", local:"Freezer Horizontal 2", setor:"Gaveta 1 - F2", nome:"Polpas de Fruta (F2)", qtd:20, min:10, info:"Freezer 2", tipo:"ingrediente" },
  { id:4, cat:"Equipamento", local:"Cozinha Central", setor:"Bancada", nome:"Fritadeira El√©trica", qtd:2, min:1, info:"Voltagem:220V", tipo:"equipamento" },
  { id:5, cat:"Material", local:"Dep√≥sito", setor:"Prateleira 4", nome:"Pratos Rasos", qtd:150, min:100, info:"Porcelana Branca", tipo:"material" }
];
localStorage.setItem('buffet_rio_db', JSON.stringify(estoque));

let equipamentosStatus = JSON.parse(localStorage.getItem('equip_status')) || { 4: { status: "em evento", onde: "Casamento - Praia" } };
localStorage.setItem('equip_status', JSON.stringify(equipamentosStatus));

/* Estado de UI */
let catAtual = "";
let setorAtual = "";
let currentProposal = null;

/* Propostas (B√°sico / Top / Premium) */
const propostas = {
  "Caf√© Manh√£": {
    "B√°sico": [{id:5, qty:30}, {id:3, qty:10}],
    "Top":    [{id:5, qty:50}, {id:3, qty:20}, {id:2, qty:10}],
    "Premium":[{id:5, qty:80}, {id:3, qty:30}, {id:2, qty:20}, {id:1, qty:10}]
  },
  "Coffee Meal": {
    "B√°sico":[{id:5, qty:20}, {id:3, qty:15}],
    "Top":[{id:5, qty:40}, {id:3, qty:30}, {id:2, qty:10}],
    "Premium":[{id:5, qty:60}, {id:3, qty:40}, {id:2, qty:20}, {id:1, qty:15}]
  },
  "Almo√ßo": {
    "B√°sico":[{id:1,qty:10},{id:5,qty:40}],
    "Top":[{id:1,qty:20},{id:5,qty:60},{id:3,qty:20}],
    "Premium":[{id:1,qty:35},{id:5,qty:80},{id:3,qty:30}]
  },
  "Janta": {
    "B√°sico":[{id:1,qty:12},{id:5,qty:40}],
    "Top":[{id:1,qty:25},{id:5,qty:70},{id:3,qty:25}],
    "Premium":[{id:1,qty:40},{id:5,qty:100},{id:3,qty:40}]
  },
  "Coquetelaria": {
    "B√°sico":[{id:5,qty:20},{id:3,qty:10}],
    "Top":[{id:5,qty:40},{id:3,qty:20}],
    "Premium":[{id:5,qty:60},{id:3,qty:40},{id:4,qty:1}]
  }
};

/* UTILIDADES DE RESERVA PROPORCIONAL */
function baseName(nome) {
  return nome.replace(/\s*\(.*\)\s*/g, '').trim().toLowerCase();
}
function totalAvailableFor(id) {
  const prod = estoque.find(p => p.id === id);
  if(!prod) return 0;
  const base = baseName(prod.nome);
  return estoque.filter(p => baseName(p.nome) === base).reduce((s,p)=>s+p.qtd,0);
}

/* Reserva proporcional entre localiza√ß√µes (balanceo proporcional).
   Retorna { allocations: [{id,nome,local,reserved}], shortage: n } y decrementa en-memory el estoque. */
function reserveAcrossLocationsProportional(id, qty) {
  const main = estoque.find(p=>p.id===id);
  if(!main) return { allocations: [], shortage: qty };

  const base = baseName(main.nome);
  const candidates = estoque.filter(p => baseName(p.nome) === base && p.qtd > 0);
  const totalAvailable = candidates.reduce((s,c)=>s+c.qtd, 0);

  if(totalAvailable <= 0) return { allocations: [], shortage: qty };

  // primera asignaci√≥n proporcional (floor)
  let allocations = [];
  let allocatedSum = 0;
  const provisional = candidates.map(c => {
    const share = Math.floor(qty * (c.qtd / totalAvailable));
    const take = Math.min(share, c.qtd);
    allocatedSum += take;
    return { c, take };
  });

  // distribuir el remanente (por ejemplo por mayor stock remanente)
  let remaining = qty - allocatedSum;
  if (remaining > 0) {
    // ordenar candidatos por (qtd - take) descendente (m√°s capacidad restante)
    const order = provisional.slice().sort((a,b) => (b.c.qtd - a.c.qtd) - (a.c.qtd - b.c.qtd));
    for (const p of order) {
      if (remaining <= 0) break;
      const canTake = Math.min(remaining, p.c.qtd - p.take);
      if (canTake > 0) {
        p.take += canTake;
        remaining -= canTake;
      }
    }
  }

  // si todav√≠a queda remaining porque alguno estaba lleno, intentar tomar de cualquier candidato con stock sobrante
  if (remaining > 0) {
    for (const p of provisional) {
      if (remaining <= 0) break;
      const canTake = Math.min(remaining, p.c.qtd - p.take);
      if (canTake > 0) {
        p.take += canTake;
        remaining -= canTake;
      }
    }
  }

  // aplicar decrementos y construir allocations
  provisional.forEach(p => {
    if (p.take > 0) {
      p.c.qtd -= p.take;
      allocations.push({ id: p.c.id, nome: p.c.nome, local: p.c.local, reserved: p.take });
    }
  });

  const shortage = Math.max(0, qty - allocations.reduce((s,a)=>s+a.reserved,0));
  return { allocations, shortage };
}

/* NAVEGA√á√ÉO / RENDERING */
function trocarCategoria(cat) { catAtual = cat; setorAtual = ""; renderizar(); }
function renderizar() {
  const titulo = document.getElementById('titulo-pagina');
  const corpo = document.getElementById('corpo-pagina');
  const navBar = document.getElementById('navegacao');
  if (!catAtual) {
    navBar.innerHTML = "";
    titulo.innerText = "Selecione uma op√ß√£o ao lado";
    corpo.innerHTML = "Escolha uma categoria para gerenciar o estoque ou criar uma proposta.";
    return;
  }
  navBar.innerHTML = `<span onclick="catAtual='';renderizar()">In√≠cio</span> > <b>${catAtual}</b>`;
  titulo.innerText = `Setores da ${catAtual}`;
  const setores = [...new Set(estoque.filter(i=>i.cat===catAtual).map(i=>i.setor))];
  let html = `<table><thead><tr><th>Setor / Localiza√ß√£o</th><th>Qtd Total</th></tr></thead><tbody>`;
  setores.forEach(s=>{
    const total = estoque.filter(i=>i.cat===catAtual && i.setor===s).reduce((a,b)=>a+b.qtd,0);
    html += `<tr class="linha-clicavel" onclick="abrirSetor('${s}')">
              <td>üìÇ Setor: <b>${s}</b></td>
              <td>${total}</td>
            </tr>`;
  });
  corpo.innerHTML = html + "</tbody></table>";
}
function abrirSetor(s) { setorAtual = s; renderizarSetor(); }
function renderizarSetor() {
  const navBar = document.getElementById('navegacao');
  navBar.innerHTML = `<span onclick="setorAtual='';renderizar()">In√≠cio > ${catAtual}</span> > <b>${setorAtual}</b>`;
  document.getElementById('titulo-pagina').innerText = `Itens em: ${setorAtual}`;
  const itens = estoque.filter(i=>i.cat===catAtual && i.setor===setorAtual);
  let html = `<table><thead><tr><th>Item</th><th>Qtd</th><th>Info T√©cnica</th><th>Movimenta√ß√£o</th></tr></thead><tbody>`;
  itens.forEach(p=>{
    html += `<tr>
      <td><b>${p.nome}</b></td>
      <td class="${p.qtd<=p.min ? 'alerta' : ''}">${p.qtd}</td>
      <td><small>${p.info||'-'}</small></td>
      <td>
        <button class="btn-qtd" onclick="ajustarEstoque(${p.id},1)">+</button>
        <button class="btn-qtd" onclick="ajustarEstoque(${p.id},-1)">-</button>
      </td>
    </tr>`;
  });
  document.getElementById('corpo-pagina').innerHTML = html + "</tbody></table>";
}
function ajustarEstoque(id, valor) {
  const item = estoque.find(i=>i.id===id);
  if(!item) return;
  item.qtd = Math.max(0, item.qtd+valor);
  localStorage.setItem('buffet_rio_db', JSON.stringify(estoque));
  if(setorAtual) renderizarSetor(); else renderizar();
}

/* EDITOR DE PROPOSTAS (cliente) */
function openProposal(tipo) {
  currentProposal = { tipo, nivel: null, selections: [] };
  document.getElementById('navegacao').innerHTML = `<span onclick="currentProposal=null; document.getElementById('proposal-preview').innerHTML='';">In√≠cio</span> > <b>Proposta: ${tipo}</b>`;
  renderProposalEditor(tipo);
}
function renderProposalEditor(tipo) {
  const preview = document.getElementById('proposal-preview');
  const niveles = Object.keys(propostas[tipo]||{});
  let html = `<div class="card"><h2>Proposta: ${tipo}</h2>
    <div class="packages">`;
  niveles.forEach(n=>{
    html += `<div class="pkg" id="pkg-${n}" onclick="selectPackage('${n}')">${n}</div>`;
  });
  html += `</div>
    <div id="pkg-items" class="items-list"></div>
    <div class="actions">
      <button class="btn primary" onclick="confirmProposal()">Confirmar e Reservar</button>
      <button class="btn ghost" onclick="clearProposal()">Cancelar</button>
    </div>
    <div id="proposal-result"></div>
  </div>`;
  preview.innerHTML = html;
}
function selectPackage(nivel) {
  currentProposal.nivel = nivel;
  document.querySelectorAll('.pkg').forEach(el=>el.classList.remove('active'));
  const el = document.getElementById('pkg-'+nivel);
  if(el) el.classList.add('active');

  // carregar itens da proposta e mostrar disponibilidade total (agregada)
  const items = propostas[currentProposal.tipo][nivel] || [];
  currentProposal.selections = items.map(it => ({ id: it.id, qty: it.qty, selected: true }));

  let html = `<div style="margin-top:10px"><strong>Itens sugeridos (ajuste quantidade se necess√°rio)</strong></div>`;
  html += `<div class="card" style="margin-top:8px">`;
  items.forEach(it=>{
    const prod = estoque.find(p=>p.id===it.id) || {nome:'Item n√£o encontrado', qtd:0};
    html += `<div class="item-row">
      <input type="checkbox" id="sel-${it.id}" checked onchange="toggleSelection(${it.id})">
      <div style="flex:1"><strong>${prod.nome}</strong><br><small>${prod.info||''} ‚Ä¢ Dispon√≠vel total: ${totalAvailableFor(it.id)}</small></div>
      <div><label>Qtd</label><br><input type="number" id="qty-${it.id}" min="1" value="${it.qty}" onchange="updateQty(${it.id})"></div>
    </div>`;
  });
  html += `</div>`;
  document.getElementById('pkg-items').innerHTML = html;
}
function toggleSelection(id) {
  const s = currentProposal.selections.find(x=>x.id===id);
  if(s) s.selected = !s.selected;
  else currentProposal.selections.push({id, qty:1, selected:false});
}
function updateQty(id) {
  const v = parseInt(document.getElementById('qty-'+id).value || 0, 10);
  const s = currentProposal.selections.find(x=>x.id===id);
  if(s) s.qty = Math.max(1, v);
}
function clearProposal() {
  currentProposal = null;
  document.getElementById('proposal-preview').innerHTML = '';
  document.getElementById('navegacao').innerHTML = '';
}

/* CONFIRMAR: reserva proporcional entre ubicaciones y notificaci√≥n click-to-chat */
function confirmProposal() {
  if(!currentProposal || !currentProposal.nivel) {
    alert('Escolha primeiro o n√≠vel (B√°sico / Top / Premium).');
    return;
  }

  const finalAllocations = [];
  const shortages = [];
  const equipIssues = [];

  for (const sel of currentProposal.selections) {
    if (!sel.selected) continue;
    const prod = estoque.find(p => p.id === sel.id);
    if (!prod) continue;

    if (prod.tipo === 'equipamento') {
      const st = equipamentosStatus[prod.id];
      if (st && st.status === 'em evento') {
        equipIssues.push({ nome: prod.nome, onde: st.onde });
        // no decrementar equipamento en este caso
        continue;
      }
      // si disponible, reservar normalmente (equipamento suele tener 1 o pocos)
      const { allocations, shortage } = reserveAcrossLocationsProportional(sel.id, sel.qty);
      allocations.forEach(a=> finalAllocations.push(a));
      if (shortage > 0) shortages.push({ id: prod.id, nome: prod.nome, need: shortage });
    } else {
      const { allocations, shortage } = reserveAcrossLocationsProportional(sel.id, sel.qty);
      allocations.forEach(a=> finalAllocations.push(a));
      if (shortage > 0) shortages.push({ id: prod.id, nome: prod.nome, need: shortage });
    }
  }

  // persistir estoque
  localStorage.setItem('buffet_rio_db', JSON.stringify(estoque));

  // Guardar √∫ltima propuesta y las asignaciones para el staff (en localStorage)
  const timestamp = new Date().toISOString();
  const lastProposal = { tipo: currentProposal.tipo, nivel: currentProposal.nivel, allocations: finalAllocations, shortages, equipIssues, timestamp };
  localStorage.setItem('last_proposal', JSON.stringify(lastProposal));

  // Render propuesta para cliente (sin mostrar origenes, solo totales)
  renderClientProposalCard(lastProposal);

  // Actualizar panel staff (all√≠ estar√°n las asignaciones con origen)
  renderStaffPanel();

  // Notificar por WhatsApp (click-to-chat) al staff si n√∫mero configurado
  const staffPhone = localStorage.getItem('staff_phone') || '';
  if (staffPhone) {
    const msg = buildWhatsAppMessage(lastProposal);
    // abrir wa.me en nueva pesta√±a
    const url = `https://wa.me/${encodeURIComponent(staffPhone)}?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
  } else {
    // si no hay n√∫mero, mostrar aviso para que staff lo configure
    document.getElementById('proposal-result')?.innerText = "Reserva realizada. Configure o n√∫mero do staff para enviar notifica√ß√£o por WhatsApp.";
  }

  currentProposal = null;
  document.getElementById('proposal-result')?.innerText = "Reserva realizada com sucesso.";
}

/* Construye el mensaje de WhatsApp con asignaciones y faltas */
function buildWhatsAppMessage(proposal) {
  const lines = [];
  lines.push(`Proposta confirmada: ${proposal.tipo} ‚Äî N√≠vel: ${proposal.nivel}`);
  lines.push(`Data: ${new Date(proposal.timestamp).toLocaleString()}`);
  lines.push('');
  if (proposal.allocations.length) {
    lines.push('Itens reservados (origem):');
    // agrupar por nome
    const grouped = {};
    proposal.allocations.forEach(a => {
      grouped[a.nome] = grouped[a.nome] || [];
      grouped[a.nome].push(a);
    });
    Object.keys(grouped).forEach(nome => {
      lines.push(`- ${nome}:`);
      grouped[nome].forEach(g => {
        lines.push(`   ‚Ä¢ ${g.reserved} ‚Äî ${g.local}`);
      });
    });
  } else {
    lines.push('Nenhum item reservado.');
  }
  if (proposal.shortages && proposal.shortages.length) {
    lines.push('');
    lines.push('Faltas / Necess√°rio comprar:');
    proposal.shortages.forEach(s => {
      lines.push(`- ${s.nome} ‚Äî falta ${s.need}`);
    });
  }
  if (proposal.equipIssues && proposal.equipIssues.length) {
    lines.push('');
    lines.push('Equipamentos indispon√≠veis:');
    proposal.equipIssues.forEach(e => lines.push(`- ${e.nome} ‚Äî ${e.onde}`));
  }
  lines.push('');
  lines.push('Ver painel do staff para detalhes.');
  return lines.join('\n');
}

/* Render cliente: muestra solo totales (sin origenes) y permite exportar la propuesta cliente */
function renderClientProposalCard(proposal) {
  const container = document.getElementById('proposal-preview');

  // agrupar allocations por producto para totales
  const totals = {};
  proposal.allocations.forEach(a => {
    const key = a.nome;
    totals[key] = (totals[key] || 0) + a.reserved;
  });

  let html = `<div style="margin-top:14px" class="card">
    <div class="proposal-card" id="proposal-card">
      <div class="proposal-header">
        <div><h2>Proposta: ${proposal.tipo}</h2><small>N√≠vel: ${proposal.nivel}</small></div>
        <div style="text-align:right"><strong>Al√©m do Bolo</strong><br><small>Gest√£o Buffet Rio</small></div>
      </div>
      <div><strong>Itens reservados:</strong></div>
      <div class="proposal-items">`;

  if (Object.keys(totals).length === 0) {
    html += `<div><em>Nenhum item reservado (verificar disponibilidade).</em></div>`;
  } else {
    Object.keys(totals).forEach(nome => {
      html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee">
        <div>${nome}</div><div><strong>${totals[nome]}</strong></div>
      </div>`;
    });
  }

  html += `</div>
      <div style="margin-top:12px">Observa√ß√µes:</div>
      <div style="margin-top:6px">`;
  if (proposal.shortages.length) {
    html += `<div style="color:#b91c1c"><strong>Alguns itens em falta ‚Äî equipe ser√° notificada.</strong></div>`;
  } else {
    html += `<div style="color:#065f46"><strong>Estoque suficiente para os itens selecionados.</strong></div>`;
  }
  html += `</div>
      <div style="margin-top:12px; font-size:0.9rem; color:#475569">Data da proposta: ${new Date(proposal.timestamp).toLocaleString()}</div>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px;">
      <button class="btn primary" onclick="exportProposalPNG()">Exportar imagem (PNG)</button>
      <button class="btn ghost" onclick="printProposal()">Imprimir</button>
    </div>
  </div>`;

  container.innerHTML = html;
}

/* Export / Print (cliente) */
function printProposal() {
  const el = document.getElementById('proposal-card');
  if(!el) return alert('Nenhuma proposta para imprimir.');
  const w = window.open('', '_blank');
  w.document.write('<html><head><title>Proposta</title></head><body>');
  w.document.write(el.outerHTML);
  w.document.write('</body></html>');
  w.document.close();
  w.print();
}
function exportProposalPNG() {
  const el = document.getElementById('proposal-card');
  if(!el) return alert('Nenhuma proposta para exportar.');
  html2canvas(el, { scale: 2 }).then(canvas=>{
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = url;
    a.download = 'proposta_buffet_rio.png';
    a.click();
  }).catch(err=>{
    console.error(err);
    alert('Erro ao gerar imagem.');
  });
}

/* PAINEL DO STAFF: muestra asignaciones por ubicaci√≥n, lista de compras y bot√≥n click-to-chat */
function openStaffPanel() {
  currentProposal = null;
  document.getElementById('proposal-preview').innerHTML = '';
  renderStaffPanel(true);
}

function renderStaffPanel(openNow) {
  const staff = document.getElementById('staff-area');
  const needToBuy = estoque.filter(i => i.qtd < i.min).map(i=>({id:i.id,nome:i.nome,falta: i.min - i.qtd, setor: i.setor}));
  equipamentosStatus = JSON.parse(localStorage.getItem('equip_status')) || equipamentosStatus;
  const lastProposal = JSON.parse(localStorage.getItem('last_proposal') || 'null');

  let html = `<div class="card"><h3>Painel do Staff</h3>`;
  html += `<div style="display:flex;gap:12px;align-items:flex-start">`;
  html += `<div style="flex:1">`;
  html += `<div><strong>Lista de Compras (itens abaixo do m√≠nimo)</strong></div>`;
  if(needToBuy.length) {
    html += `<ul>`;
    needToBuy.forEach(n=> html += `<li>${n.nome} ‚Äî falta ${n.falta} (${n.setor})</li>`);
    html += `</ul>`;
  } else {
    html += `<div class="note">Nenhum item cr√≠tico no momento.</div>`;
  }
  html += `</div>`;

  // Right column: equipamentos + config WhatsApp + √∫ltima proposta con or√≠genes
  html += `<div style="width:360px">`;
  html += `<div><strong>Equipamentos</strong></div>`;
  html += `<ul>`;
  Object.keys(equipamentosStatus).forEach(k=>{
    const st = equipamentosStatus[k];
    const prod = estoque.find(p=>p.id==k);
    html += `<li>${prod?prod.nome:'Equipamento '+k} ‚Äî <em>${st.status}</em> ${st.onde?'- '+st.onde:''}</li>`;
  });
  html += `</ul>`;

  // Phone staff config
  const staffPhone = localStorage.getItem('staff_phone') || '';
  html += `<div style="margin-top:8px"><strong>N√∫mero do staff (WhatsApp)</strong>`;
  html += `<input id="staff-phone" class="small" placeholder="5511999999999" value="${staffPhone}">`;
  html += `<div style="display:flex;gap:6px;margin-top:6px"><button class="btn primary" onclick="saveStaffPhone()">Salvar n√∫mero</button>`;
  html += `<button class="btn ghost" onclick="sendLastProposalWhatsApp()">Enviar √∫ltima proposta por WhatsApp</button></div></div>`;

  // Last proposal details for staff (origins)
  html += `<div style="margin-top:10px"><strong>√öltima Proposta (detalhes de origem)</strong>`;
  if (lastProposal) {
    html += `<div style="font-size:0.9rem;margin-top:6px"><em>${new Date(lastProposal.timestamp).toLocaleString()}</em></div>`;
    if (lastProposal.allocations.length) {
      html += `<div style="margin-top:6px">`;
      // agrupar por producto
      const grouped = {};
      lastProposal.allocations.forEach(a=> {
        grouped[a.nome] = grouped[a.nome] || [];
        grouped[a.nome].push(a);
      });
      Object.keys(grouped).forEach(nome => {
        html += `<div style="margin-top:6px"><strong>${nome}</strong>`;
        grouped[nome].forEach(g => {
          html += `<div style="display:flex;justify-content:space-between;padding:4px 0">
                     <div style="color:#475569">${g.local}</div><div><strong>${g.reserved}</strong></div>
                   </div>`;
        });
        html += `</div>`;
      });
      html += `</div>`;
    } else {
      html += `<div style="margin-top:6px"><em>Nenhuma aloca√ß√£o.</em></div>`;
    }
    if (lastProposal.shortages.length) {
      html += `<div style="margin-top:8px;color:#b91c1c"><strong>Faltas:</strong><ul>`;
      lastProposal.shortages.forEach(s=> html += `<li>${s.nome} ‚Äî falta ${s.need}</li>`);
      html += `</ul></div>`;
    }
    if (lastProposal.equipIssues && lastProposal.equipIssues.length) {
      html += `<div style="margin-top:8px;color:#92400e"><strong>Equipamentos indispon√≠veis:</strong><ul>`;
      lastProposal.equipIssues.forEach(e=> html += `<li>${e.nome} ‚Äî ${e.onde}</li>`);
      html += `</ul></div>`;
    }
  } else {
    html += `<div style="margin-top:6px"><em>Nenhuma proposta registrada ainda.</em></div>`;
  }

  html += `</div>`; // close right column
  html += `</div>`; // close flex

  html += `<div style="margin-top:10px"><small>√öltima atualiza√ß√£o: ${new Date().toLocaleString()}</small></div>`;
  html += `</div>`;
  staff.innerHTML = html;

  if(openNow) staff.scrollIntoView({behavior:'smooth'});
}

/* Guardar n√∫mero staff */
function saveStaffPhone() {
  const el = document.getElementById('staff-phone');
  if (!el) return;
  const v = (el.value || '').trim();
  if (!v) { alert('Informe o telefone no formato internacional sem sinais (ex: 5511999999999)'); return; }
  localStorage.setItem('staff_phone', v);
  alert('N√∫mero do staff salvo.');
}

/* Enviar √∫ltima proposta por WhatsApp (click-to-chat) */
function sendLastProposalWhatsApp() {
  const staffPhone = localStorage.getItem('staff_phone') || '';
  if (!staffPhone) { alert('Configure primeiro o n√∫mero do staff.'); return; }
  const lastProposal = JSON.parse(localStorage.getItem('last_proposal') || 'null');
  if (!lastProposal) { alert('N√£o h√° proposta para enviar.'); return; }
  const msg = buildWhatsAppMessage(lastProposal);
  const url = `https://wa.me/${encodeURIComponent(staffPhone)}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}

/* Inicial render */
renderizar();
renderStaffPanel();

</script>
</body>
</html>
